import streamlit as st
import random
import time

# --- ìºë¦­í„° ë° ëª¬ìŠ¤í„° í´ë˜ìŠ¤ ì •ì˜ ---
class Character:
    def __init__(self, name, max_hp, attack_power):
        self.name = name
        self.max_hp = max_hp
        self.hp = max_hp
        self.attack_power = attack_power
        self.level = 1
        self.exp = 0
        self.exp_to_level_up = 20
        self.gold = 0
        self.items = {"heal_potion": 5, "magic_scroll": 0}
        self.scroll_ready = False
        self.class_type = None
        self.energy = 0
        self.reflect_mode = False
        self.stun_next_turn = False

    def attack(self, target):
        base = self.attack_power
        if self.scroll_ready:
            base *= 4
            st.markdown("ğŸ’¥ **ë§ˆë²• ìŠ¤í¬ë¡¤ì˜ í˜ì´ ë°œë™ë˜ì–´ ê°•ë ¥í•œ ê³µê²©ì„ ë‚ ë¦½ë‹ˆë‹¤!**")
            self.scroll_ready = False
        damage = random.randint(base - 2, base + 2)
        target.take_damage(damage)
        return f"{self.name}ê°€ {target.name}ì—ê²Œ **{damage}ì˜ ë°ë¯¸ì§€**ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!"

    def heal(self):
        heal_amount = random.randint(30, 50)
        self.hp = min(self.hp + heal_amount, self.max_hp)
        return f"{self.name}ê°€ **{heal_amount}ë§Œí¼ íšŒë³µ**í–ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ì²´ë ¥: {self.hp})"

    def use_skill(self, target, skill_choice):
        if self.energy < 3:
            return "âš ï¸ ì—ë„ˆì§€ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"

        self.energy -= 3

        if self.class_type == "mage":
            if skill_choice == "ì•„ì´ìŠ¤ë³¼":
                damage = int(self.attack_power * 1.5)
                target.take_damage(damage)
                msg = f"â„ï¸ ì•„ì´ìŠ¤ë³¼! {target.name}ì—ê²Œ {damage}ì˜ í”¼í•´!"
                if random.random() < 0.5:
                    target.stun_next_turn = True
                    msg += "\nğŸŒ¨ï¸ ì ì´ ì–¼ì–´ë¶™ì–´ ë‹¤ìŒ ê³µê²©ì„ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                return msg
            elif skill_choice == "ìµìŠ¤í”Œë¡œì „":
                damage = int(self.attack_power * 2)
                target.take_damage(damage)
                msg = f"ğŸ’¥ ìµìŠ¤í”Œë¡œì „! {target.name}ì—ê²Œ {damage}ì˜ í”¼í•´!"
                if random.random() < 0.25:
                    bonus = int(self.attack_power * 1.5)
                    target.take_damage(bonus)
                    msg += f"\nğŸ”¥ ì¶”ê°€ í­ë°œ! {bonus}ì˜ ì¶”ê°€ í”¼í•´!"
                return msg

        elif self.class_type == "warrior":
            if skill_choice == "ê°€ì‹œë°©íŒ¨":
                self.reflect_mode = True
                return "ğŸ›¡ï¸ ê°€ì‹œë°©íŒ¨ë¥¼ ë“¤ê³  ëŒ€ê¸°í•©ë‹ˆë‹¤. ì´ë²ˆ í„´ ì  ê³µê²© ë°˜ì‚¬! (ìë™ ì ìš©)"
            elif skill_choice == "ì´íŒì‚¬íŒíƒœí´":
                damage = int(self.attack_power * 4)
                self_damage = int(self.attack_power * 0.25)
                target.take_damage(damage)
                self.hp -= self_damage
                return f"ğŸ¤œ ì´íŒì‚¬íŒíƒœí´! {target.name}ì—ê²Œ {damage} í”¼í•´! ìì‹ ì€ {self_damage} í”¼í•´!"
        return "â“ ì•Œ ìˆ˜ ì—†ëŠ” ìŠ¤í‚¬"

    def gain_exp(self, amount):
        self.exp += amount
        level_up_text = f"ğŸ‰ {self.name}ê°€ {amount} ê²½í—˜ì¹˜ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤! ({self.exp}/{self.exp_to_level_up})\n"
        if self.exp >= self.exp_to_level_up:
            self.level += 1
            self.exp -= self.exp_to_level_up
            self.exp_to_level_up = int(self.exp_to_level_up * 1.5)
            self.max_hp += 10
            self.attack_power += 3
            self.hp = self.max_hp
            level_up_text += f"âœ¨ **ë ˆë²¨ ì—…!** {self.name}ëŠ” ë ˆë²¨ {self.level}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!"
        return level_up_text

    def gain_gold(self, amount):
        self.gold += amount
        return f"ğŸ’° {amount} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤! (ë³´ìœ  ê³¨ë“œ: {self.gold})"

    def take_damage(self, amount):
        self.hp -= amount

    def is_alive(self):
        return self.hp > 0


class Monster(Character):
    def __init__(self, floor):
        name = random.choice(["ê³ ë¸”ë¦°", "ìŠ¬ë¼ì„", "ëŠ‘ëŒ€", "í•´ê³¨ ì „ì‚¬", "ë¶ˆì˜ ì •ë ¹", "ì–´ë‘ ì˜ ê¸°ì‚¬"])
        max_hp = 30 + floor * 5
        attack_power = 8 + floor // 2
        super().__init__(f"{floor}ì¸µì˜ {name}", max_hp, attack_power)
        self.exp_reward = 10 + floor * 2
        self.gold_reward = random.randint(50, 100)


class BossMonster(Monster):
    def __init__(self, floor, name, nickname, speech, gimmick=None):
        super().__init__(floor)
        self.name = f"{floor}ì¸µ ë³´ìŠ¤ [{nickname}] {name}"
        self.hp = 150 + floor * 10
        self.max_hp = self.hp
        self.attack_power = 20 + floor // 2
        self.exp_reward = 50 + floor * 3
        self.gold_reward = 200 + floor * 5
        self.speech = speech
        self.gimmick = gimmick
        self.turns = 0

    def take_damage(self, amount):
        if self.gimmick == "sans":
            self.turns += 1
            if self.turns <= 20:
                st.markdown("ìƒŒì¦ˆëŠ” í”¼í•˜ì§€ ì•Šì•˜ë‹¤... í•˜ì§€ë§Œ ê³µê²©ì´ ì•„ë¬´ íš¨ê³¼ê°€ ì—†ë‹¤!")
            else:
                st.markdown("ë‹¹ì‹ ì˜ ê³µê²©ì´ ìƒŒì¦ˆì—ê²Œ ëª…ì¤‘í–ˆë‹¤!")
                self.hp = 0
        else:
            self.hp -= amount

    def special_attack(self, player):
        if self.gimmick == "stun_every_3_turns" and self.turns % 3 == 0:
            player.stun_next_turn = True
            return f"{self.name}ì˜ íŠ¹ìˆ˜ ê³µê²©! {player.name}ì´(ê°€) ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!"
        return ""


def create_enemy(floor):
    if floor == 10:
        return BossMonster(10, "ë¸”ëŸ¬ë“œ ë ˆì´ë¸", "í•ë¹› ì°¸ê²©ì", "í¬ì•„í•˜í•˜í•˜! ë‚´ ê²€ì€ í”¼ë¥¼ ì›í•œë‹¤ë©´, ë„¤ í”¼ë¶€í„° í˜ë ¤ì•¼ê² ì§€!", gimmick="stun_every_3_turns")
    elif floor == 20:
        return BossMonster(20, "ì„€ë„ìš° ë¦¬í¼", "ì–´ë‘ ì˜ ì ˆë‹¨ì", "ë¹› ë”°ìœ„ëŠ”... ë‚´ ê²€ ì•ì—ì„  ë¬´ì˜ë¯¸í•˜ë‹¤.", gimmick="stun_every_3_turns")
    elif floor == 30:
        return BossMonster(30, "ìƒŒì¦ˆ", "ë§ˆì§€ë§‰ íƒ‘ì˜ ìˆ˜í˜¸ì", "ì •ë§ ì•„ë¦„ë‹¤ìš´ ë‚ ì´ì•¼.\nìƒˆë“¤ì€ ì§€ì €ê·€ê³ , ê½ƒë“¤ì€ í”¼ì–´ë‚˜ê³ ...\nì´ëŸ° ë‚ ì—”, ë„ˆ ê°™ì€ ê¼¬ë§ˆë“¤ì€...\n(ëˆˆë™ìê°€ ì‚¬ë¼ì§€ë©°)ì§€ì˜¥ì—ì„œ ë¶ˆíƒ€ê³  ìˆì–´ì•¼ í•˜ëŠ”ë°.", gimmick="sans")
    else:
        return Monster(floor)


# --- ìƒíƒœ ì´ˆê¸°í™” ---
def init_game():
    st.session_state.player = Character("ìš©ì‚¬", 100, 15)
    st.session_state.floor = 1
    st.session_state.enemy = create_enemy(1)
    st.session_state.log = []
    st.session_state.game_over = False
    st.session_state.shop_mode = False
    st.session_state.skill_mode = False

# --- Streamlit UI ---
st.title("ğŸ¯ 30ì¸µ íƒ‘ ì •ë³µ RPG")

if "player" not in st.session_state:
    init_game()

player = st.session_state.player
enemy = st.session_state.enemy

# --- ì „íˆ¬ ìƒí™© ì¶œë ¥ ---
st.markdown(f"**{player.name}** - HP: {player.hp}/{player.max_hp}, Lv.{player.level}, ì—ë„ˆì§€: {player.energy}")
st.markdown(f"**{enemy.name}** - HP: {enemy.hp}/{enemy.max_hp}")

# --- ë¡œê·¸ ì¶œë ¥ ---
for log in st.session_state.log[-5:]:
    st.markdown(log)

# --- í–‰ë™ ì„ íƒ ---
col1, col2, col3 = st.columns(3)

with col1:
    if st.button("âš”ï¸ ê³µê²©"):
        if not player.stun_next_turn:
            st.session_state.log.append(player.attack(enemy))
        else:
            st.session_state.log.append("âš ï¸ ë‹¹ì‹ ì€ ê¸°ì ˆí•´ì„œ ì•„ë¬´ í–‰ë™ë„ ëª»í–ˆìŠµë‹ˆë‹¤!")
            player.stun_next_turn = False

with col2:
    if st.button("ğŸ’ ì•„ì´í…œ"):
        if player.items["heal_potion"] > 0:
            player.items["heal_potion"] -= 1
            st.session_state.log.append(player.heal())
        else:
            st.session_state.log.append("âŒ ë¬¼ì•½ì´ ì—†ìŠµë‹ˆë‹¤!")

with col3:
    if player.class_type:
        skill = st.selectbox("ğŸ§ª ìŠ¤í‚¬ ì„ íƒ", ["ì•„ì´ìŠ¤ë³¼", "ìµìŠ¤í”Œë¡œì „"] if player.class_type == "mage" else ["ê°€ì‹œë°©íŒ¨", "ì´íŒì‚¬íŒíƒœí´"])
        if st.button("ğŸ”® ìŠ¤í‚¬ ì‚¬ìš©"):
            result = player.use_skill(enemy, skill)
            st.session_state.log.append(result)

# --- ì  í„´ ---
if enemy.is_alive():
    if isinstance(enemy, BossMonster):
        enemy.turns += 1
        boss_msg = enemy.special_attack(player)
        if boss_msg:
            st.session_state.log.append(boss_msg)

    if not enemy.stun_next_turn:
        damage = random.randint(enemy.attack_power - 2, enemy.attack_power + 2)
        player.take_damage(damage)
        st.session_state.log.append(f"ğŸ‘¿ {enemy.name}ì´(ê°€) {player.name}ì—ê²Œ {damage} í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!")
    else:
        st.session_state.log.append(f"â„ï¸ {enemy.name}ì´(ê°€) ì–¼ì–´ë¶™ì–´ ê³µê²©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!")
        enemy.stun_next_turn = False

player.energy += 1

# --- ì „íˆ¬ ê²°ê³¼ ì²´í¬ ---
if not enemy.is_alive():
    st.success(f"ğŸ‰ {enemy.name} ê²©íŒŒ!")
    st.session_state.log.append(player.gain_exp(enemy.exp_reward))
    st.session_state.log.append(player.gain_gold(enemy.gold_reward))
    st.session_state.floor += 1

    if st.session_state.floor > 30:
        st.balloons()
        st.markdown("ğŸ† **ì¶•í•˜í•©ë‹ˆë‹¤! 30ì¸µì„ ëª¨ë‘ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!**")
        st.stop()

    st.session_state.enemy = create_enemy(st.session_state.floor)
    st.markdown(f"â¡ï¸ **{st.session_state.floor}ì¸µìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...**")

if not player.is_alive():
    st.error("ğŸ’€ ë‹¹ì‹ ì€ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤... ê²Œì„ ì˜¤ë²„.")
    if st.button("ğŸ” ë‹¤ì‹œ ì‹œì‘"):
        init_game()
